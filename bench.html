<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>马丁内斯死在惊奇馆</title>
    <meta http-equiv=“Pragma” content="no-cache">
    <meta http-equiv=“Expires” content="-1">
    <meta http-equiv=“CACHE-CONTROL” content="NO-CACHE">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,500;1,700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>

    <link rel="stylesheet" href="https://unpkg.com/viewerjs/dist/viewer.css" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="sticky top-0 px-6 py-6 bg-white shadow-lg">
        <!-- This example requires Tailwind CSS v2.0+ -->
        <div class="md:flex md:items-center md:justify-between container mx-auto">
            <div class="flex-1 min-w-0">
                <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate" id="character-name">
                    -
                </h2>
            </div>
            <div class="mt-5 flex md:mt-0 md:ml-4">
                <span class="md:ml-3 space-x-2" id="download-script">
                </span>
            </div>
        </div>
    </div>


    <!-- a block container is required -->
    <div class="mt-2 px-6 py-6 container mx-auto space-y-14 sm:space-y-16" id="images">
    </div>

    <div class="text-center" id="images-empty">
        <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" stroke="currentColor"
            fill="none" viewBox="0 0 48 48" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 14v20c0 4.418 7.163 8 16 8 1.381 0 2.721-.087 4-.252M8 14c0 4.418 7.163 8 16 8s16-3.582 16-8M8 14c0-4.418 7.163-8 16-8s16 3.582 16 8m0 0v14m0-4c0 4.418-7.163 8-16 8S8 28.418 8 24m32 10v6m0 0v6m0-6h6m-6 0h-6" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">目前没有线索卡</h3>
        <p class="mt-1 text-sm text-gray-500">请阅读剧本，并耐心等待下一阶段</p>
    </div>

    <div class="fixed top-40 inset-x-0 pb-2 sm:pb-5 sm:top-28" id="notification">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
            <div class="p-2 rounded-lg bg-neutral-800 shadow-lg sm:p-3">
                <div class="flex items-center justify-between flex-wrap">
                    <div class="w-0 flex-1 flex items-center">
                        <span class="flex p-2 rounded-lg bg-indigo-800">
                            <!-- Heroicon name: outline/speakerphone -->
                            <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                            </svg>
                        </span>
                        <p class="ml-3 font-medium text-white truncate">
                            <span class="md:hidden">剧本 / 线索卡: 已更新</span>
                            <span class="hidden md:inline">剧本 / 线索卡: 已更新</span>
                        </p>
                    </div>
                    <div class="order-2 flex-shrink-0 sm:order-3 sm:ml-2">
                        <button type="button" id="notification-dismiss"
                            class="-mr-1 flex p-2 rounded-md hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-white">
                            <span class="sr-only">Dismiss</span>
                            <!-- Heroicon name: outline/x -->
                            <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/viewerjs/dist/viewer.js" crossorigin="anonymous"></script>
    <script src="jquery-viewer/dist/jquery-viewer.js"></script>
    <script>
        $("#notification").hide();

        $("#notification-dismiss").click(function () {
            $("#notification").hide();
        });
    </script>

    <script>
        let conf = {};

        // https://www.npoint.io/docs/2d76c239b0399e1f8988
        setInterval(() => {
            // Fetch data from configuration.json
            fetch('https://api.npoint.io/2d76c239b0399e1f8988?' + Date.now(),
                {
                    cache: "no-store",
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    if (JSON.stringify(conf) != JSON.stringify(data)) {
                        if (JSON.stringify(conf) != "{}") {
                            $("#notification").show();
                        }

                        conf = data;
                        setup();
                    }
                })
        }, 1000);
    </script>

    <script>
        if (!window.localStorage.getItem('character')) {
            window.location.href = 'character.html?' + Date.now();
        }

        $(() => {
            let character = JSON.parse(window.localStorage.getItem('character'));
            let name = character.name1;
            $('#character-name').text(name);
        })

        // read from localStorage
        const setup = () => {
            let character = JSON.parse(window.localStorage.getItem('character'));

            let name = "";
            let download_script_container = $("#download-script");
            download_script_container.empty();


            const script_stage = conf.script;
            if (script_stage >= 1) {
                name += character.name1;

                const download_link = character.script1;
                console.log(download_link);
                download_script_container.append(`
                    <button type="button"
                        class="script-download inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-neutral-800 hover:bg-neutral-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        download-link="${download_link}">
                        剧本 1
                    </button>
                `);
            }

            if (script_stage >= 2) {
                name += " / " + character.name2;

                const download_link = character.script2;
                download_script_container.append(`
                    <button type="button"
                        class="script-download inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-neutral-800 hover:bg-neutral-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        download-link="${download_link}">
                        剧本 2
                    </button>
                `);
            }

            $("#character-name").text(name);

            // Cards
            $("#images").empty();
            const unlocked_stages = conf.card;
            const stacks = {
                "1": 6,
                "2.1": 16,
                "2.2": 1,
                "2.3": 1,
                "3": 6,
                "4.1": 15,
                "4.2": 1,
                "5.1": 6,
                "5.2": 6,
                "6": 14,
                "7": 6,
                "8": 8,
                "9": 2,
                "10": 6
            };

            // for each unlocked stack
            for (let stage of unlocked_stages) {
                const stack = stacks[stage]; // amount of cards in the stack
                console.log("stack", stage + ":", stack);

                let html = "";
                html += `<p class="font-bold mb-2 font-md">阶段 ${stage}</p>`;
                html += `<ul id="cards-${stage}" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-5 items-center content-center">`;

                for (let t = 1; t <= stack; t++) {
                    html += `<li><img src="card/card/stage-${stage}/card-${t}.jpg" alt="Stage ${stage} - Card ${t}"></li>`;
                }

                html += `</ul>`;

                $("#images").append(html);
                $(`#cards-${stage}`).viewer();
            }

            if (unlocked_stages.length == 0) {
                $("#images").hide();
                $("#images-empty").show();
            } else {
                $("#images").show();
                $("#images-empty").hide();
            }

            // Script button
            $(".script-download").click(function () {
                let download_link = $(this).attr("download-link");
                window.open("script/" + download_link);
            });
        };


    </script>
</body>

</html>